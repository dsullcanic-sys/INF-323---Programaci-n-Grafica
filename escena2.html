<!DOCTYPE html>
<head></head>
<body>
<canvas id="webglcanvas" style="border: none" width="800" height="600"></canvas>
<script id="vs" type="vertex">
#version 300 es
uniform mat4 uMatrizProyeccion;
uniform mat4 uMatrizVista;
uniform mat4 uMatrizModelo;
layout(location=0) in vec2 aVertices;
layout(location=1) in vec4 aColores;
out vec4 vColores;
void main() {
    vColores = aColores;
    gl_Position = uMatrizProyeccion * uMatrizVista * uMatrizModelo * vec4(aVertices, 0.0, 1.0);
}
</script>
<script id="fs" type="fragment">
#version 300 es
precision mediump float;
in vec4 vColores;
out vec4 color;
void main() {
    color = vColores;
}
</script>
<script>
let gl, uMatrizProyeccion, uMatrizVista, uMatrizModelo;
let MatrizProyeccion = new Array(16);
let MatrizVista = new Array(16);
let MatrizModelo = new Array(16);

// ---------------- MATRICES ----------------
function identidad(r){
  r[0]=1;r[4]=0;r[8]=0;r[12]=0;
  r[1]=0;r[5]=1;r[9]=0;r[13]=0;
  r[2]=0;r[6]=0;r[10]=1;r[14]=0;
  r[3]=0;r[7]=0;r[11]=0;r[15]=1;
}
function ortho(r, izq, der, abj, arr, cerca, lejos){
  r[0] = 2/(der-izq); r[4]=0; r[8]=0; r[12]=-(der+izq)/(der-izq);
  r[1] = 0; r[5]=2/(arr-abj); r[9]=0; r[13]=-(arr+abj)/(arr-abj);
  r[2] = 0; r[6]=0; r[10]=-2/(lejos-cerca); r[14]=-(lejos+cerca)/(lejos-cerca);
  r[3] = 0; r[7]=0; r[11]=0; r[15]=1;
}
function multiplica(c,a,b){
  let r=new Array(16);
  for(let i=0;i<4;i++){
    for(let j=0;j<4;j++){
      let s=0;
      for(let k=0;k<4;k++) s+=a[i+k*4]*b[k+j*4];
      r[i+j*4]=s;
    }
  }
  for(let i=0;i<16;i++) c[i]=r[i];
}

// ---------------- CREAR FIGURAS ----------------
function crearFigura({tipo, ancho=1, alto=1, radio=1, cx=0, cy=0, sx=1, sy=1, angulo=0, angInicio=0, angFin=360, r=1,g=1,b=1}){
  let vertices=[], colores=[];
  if(tipo==='circulo'){
    for(let i=angInicio;i<=angFin;i++){
      vertices.push(cx + sx*radio*Math.cos(i*Math.PI/180));
      vertices.push(cy + sy*radio*Math.sin(i*Math.PI/180));
      colores.push(r,g,b,1);
    }
    return {vao: crearVAO(vertices,colores), count: vertices.length/2, mode: gl.TRIANGLE_FAN};
  }
  if(tipo==='rectangulo'){
    let w = ancho/2*sx, h = alto/2*sy;
    vertices = [cx-w,cy-h, cx+w,cy-h, cx+w,cy+h, cx-w,cy+h];
    for(let i=0;i<4;i++) colores.push(r,g,b,1);
    return {vao: crearVAO(vertices,colores), count:4, mode: gl.TRIANGLE_FAN};
  }
  if(tipo==='triangulo'){
    let h = alto/2;
    vertices = [cx,cy+h, cx-ancho/2,cy-h, cx+ancho/2,cy-h];
    for(let i=0;i<3;i++) colores.push(r,g,b,1);
    return {vao: crearVAO(vertices,colores), count:3, mode: gl.TRIANGLES};
  }
}

// FunciÃ³n auxiliar VAO
function crearVAO(vertices,colores){
  let vao=gl.createVertexArray();
  gl.bindVertexArray(vao);
  let bufferV=gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER,bufferV);
  gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertices),gl.STATIC_DRAW);
  gl.enableVertexAttribArray(0);
  gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);
  let bufferC=gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER,bufferC);
  gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(colores),gl.STATIC_DRAW);
  gl.enableVertexAttribArray(1);
  gl.vertexAttribPointer(1,4,gl.FLOAT,false,0,0);
  gl.bindVertexArray(null);
  return vao;
}

// ---------------- DRAW ----------------
function drawFigura(fig){
  gl.bindVertexArray(fig.vao);
  gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
  gl.drawArrays(fig.mode,0,fig.count);
  gl.bindVertexArray(null);
}

// ---------------- MAIN ----------------
function main(){
  let canvas = document.getElementById("webglcanvas");
  gl = canvas.getContext("webgl2");
  if(!gl){alert("WebGL2 no soportado"); return;}

  let vs=gl.createShader(gl.VERTEX_SHADER);
  gl.shaderSource(vs,document.getElementById("vs").text.trim());
  gl.compileShader(vs);
  let fs=gl.createShader(gl.FRAGMENT_SHADER);
  gl.shaderSource(fs,document.getElementById("fs").text.trim());
  gl.compileShader(fs);
  let prog=gl.createProgram();
  gl.attachShader(prog,vs); gl.attachShader(prog,fs);
  gl.linkProgram(prog); gl.useProgram(prog);

  uMatrizProyeccion = gl.getUniformLocation(prog,"uMatrizProyeccion");
  uMatrizVista = gl.getUniformLocation(prog,"uMatrizVista");
  uMatrizModelo = gl.getUniformLocation(prog,"uMatrizModelo");

  ortho(MatrizProyeccion,-10,10,-6,6,-1,1);
  identidad(MatrizVista);
  identidad(MatrizModelo);
  gl.uniformMatrix4fv(uMatrizProyeccion,false,MatrizProyeccion);
  gl.uniformMatrix4fv(uMatrizVista,false,MatrizVista);

  gl.clearColor(0.9,0.9,0.9,1);
  gl.clear(gl.COLOR_BUFFER_BIT);

  // ---------------- PERSONAJES ----------------
  // Stan
  let cabezaStan = crearFigura({tipo:'circulo', radio:1, cx:-7, cy:0, r:1,g:0.87,b:0.72});
  let gorroAzulStan = crearFigura({tipo:'circulo', radio:1, cx:-7, cy:0, angInicio:0, angFin:180, r:0,g:0,b:1});
  let bandaRojaStan = crearFigura({tipo:'rectangulo', ancho:2, alto:0.3, cx:-7, cy:0.15, r:1,g:0,b:0});
  let pomponStan = crearFigura({tipo:'circulo', radio:0.2, cx:-7, cy:1, r:1,g:0,b:0});
  let ojoIzqStan = crearFigura({tipo:'circulo', radio:0.25, cx:-7.35, cy:-0.2, r:1,g:1,b:1});
  let pupilaIzqStan = crearFigura({tipo:'circulo', radio:0.08, cx:-7.35, cy:-0.2, r:0,g:0,b:0});
  let ojoDerStan = crearFigura({tipo:'circulo', radio:0.25, cx:-6.65, cy:-0.2, r:1,g:1,b:1});
  let pupilaDerStan = crearFigura({tipo:'circulo', radio:0.08, cx:-6.65, cy:-0.2, r:0,g:0,b:0});
  let bocaStan = crearFigura({tipo:'rectangulo', ancho:0.8, alto:0.1, cx:-7, cy:-0.7, r:0,g:0,b:0});

  drawFigura(cabezaStan);
  drawFigura(gorroAzulStan);
  drawFigura(bandaRojaStan);
  drawFigura(pomponStan);
  drawFigura(ojoIzqStan);
  drawFigura(pupilaIzqStan);
  drawFigura(ojoDerStan);
  drawFigura(pupilaDerStan);
  drawFigura(bocaStan);

  // Kyle
  let cabezaKyle = crearFigura({tipo:'circulo', radio:1, cx:-3, cy:0, r:1,g:0.87,b:0.72});
  let gorroVerdeKyle = crearFigura({tipo:'rectangulo', ancho:2.2, alto:1.2, cx:-3, cy:0.5, r:0,g:1,b:0});
  let orejerasKyle = crearFigura({tipo:'rectangulo', ancho:2.5, alto:0.4, cx:-3, cy:0.1, r:0,g:0.6,b:0});
  let ojoIzqKyle = crearFigura({tipo:'circulo', radio:0.25, cx:-3.35, cy:-0.2, r:1,g:1,b:1});
  let pupilaIzqKyle = crearFigura({tipo:'circulo', radio:0.08, cx:-3.35, cy:-0.2, r:0,g:0,b:0});
  let ojoDerKyle = crearFigura({tipo:'circulo', radio:0.25, cx:-2.65, cy:-0.2, r:1,g:1,b:1});
  let pupilaDerKyle = crearFigura({tipo:'circulo', radio:0.08, cx:-2.65, cy:-0.2, r:0,g:0,b:0});
  let bocaKyle = crearFigura({tipo:'rectangulo', ancho:0.8, alto:0.1, cx:-3, cy:-0.7, r:0,g:0,b:0});

  drawFigura(cabezaKyle);
  drawFigura(gorroVerdeKyle);
  drawFigura(orejerasKyle);
  drawFigura(ojoIzqKyle);
  drawFigura(pupilaIzqKyle);
  drawFigura(ojoDerKyle);
  drawFigura(pupilaDerKyle);
  drawFigura(bocaKyle);

  // Cartman
  let cabezaCartman = crearFigura({tipo:'circulo', radio:1, cx:3, cy:0, r:1,g:0.87,b:0.72});
  let gorroCelesteCartman = crearFigura({tipo:'circulo', radio:1, cx:3, cy:0, angInicio:0, angFin:180, r:0,g:0.8,b:1});
  let bandaAmarillaCartman = crearFigura({tipo:'rectangulo', ancho:2, alto:0.2, cx:3, cy:0.15, r:1,g:1,b:0});
  let pomponCartman = crearFigura({tipo:'circulo', radio:0.2, cx:3, cy:1, r:1,g:1,b:0});
  let ojoIzqCartman = crearFigura({tipo:'circulo', radio:0.25, cx:2.65, cy:-0.2, r:1,g:1,b:1});
  let pupilaIzqCartman = crearFigura({tipo:'circulo', radio:0.08, cx:2.65, cy:-0.2, r:0,g:0,b:0});
  let ojoDerCartman = crearFigura({tipo:'circulo', radio:0.25, cx:3.35, cy:-0.2, r:1,g:1,b:1});
  let pupilaDerCartman = crearFigura({tipo:'circulo', radio:0.08, cx:3.35, cy:-0.2, r:0,g:0,b:0});
  let bocaCartman = crearFigura({tipo:'rectangulo', ancho:0.9, alto:0.1, cx:3, cy:-0.7, r:0,g:0,b:0});

  drawFigura(cabezaCartman);
  drawFigura(gorroCelesteCartman);
  drawFigura(bandaAmarillaCartman);
  drawFigura(pomponCartman);
  drawFigura(ojoIzqCartman);
  drawFigura(pupilaIzqCartman);
  drawFigura(ojoDerCartman);
  drawFigura(pupilaDerCartman);
  drawFigura(bocaCartman);

  // Kenny
  let capuchaKenny = crearFigura({tipo:'circulo', radio:1.2, cx:7, cy:0, r:1,g:0.5,b:0});
  let caraKenny = crearFigura({tipo:'circulo', radio:0.9, cx:7, cy:0, r:1,g:0.87,b:0.72});
  let ojoIzqKenny = crearFigura({tipo:'circulo', radio:0.2, cx:6.7, cy:-0.1, r:1,g:1,b:1});
  let pupilaIzqKenny = crearFigura({tipo:'circulo', radio:0.07, cx:6.7, cy:-0.1, r:0,g:0,b:0});
  let ojoDerKenny = crearFigura({tipo:'circulo', radio:0.2, cx:7.3, cy:-0.1, r:1,g:1,b:1});
  let pupilaDerKenny = crearFigura({tipo:'circulo', radio:0.07, cx:7.3, cy:-0.1, r:0,g:0,b:0});
  let bocaKenny = crearFigura({tipo:'rectangulo', ancho:0.7, alto:0.08, cx:7, cy:-0.5, r:0,g:0,b:0});

  drawFigura(capuchaKenny);
  drawFigura(caraKenny);
  drawFigura(ojoIzqKenny);
  drawFigura(pupilaIzqKenny);
  drawFigura(ojoDerKenny);
  drawFigura(pupilaDerKenny);
  drawFigura(bocaKenny);

}

window.onload = main;
</script>
</body>
</html>
