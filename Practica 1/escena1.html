<!DOCTYPE html>
<html>
<head></head>
<body>
<canvas id="webglcanvas" width="500" height="500" style="border:none"></canvas>

<script id="vs" type="vertex">
    #version 300 es
    uniform mat4 uMatrizProyeccion;
    uniform mat4 uMatrizVista;
    uniform mat4 uMatrizModelo;

    layout (location = 0) in vec2 aVertices;
    layout (location = 1) in vec4 aColores;

    out vec4 vColores;

    void main() {
        vColores = aColores;
        gl_Position = uMatrizProyeccion * uMatrizVista * uMatrizModelo * vec4(aVertices, 0.0, 1.0);
    }
</script>

<script id="fs" type="fragment">
    #version 300 es
    precision mediump float;
    in vec4 vColores;
    out vec4 color;
    void main() {
        color = vColores;
    }
</script>

<script>
let gl, canvas;
let uMatrizProyeccion, uMatrizVista, uMatrizModelo;
let MatrizProyeccion = new Array(16);
let MatrizVista = new Array(16);
let MatrizModelo = new Array(16);

// Matriz identidad
function identidad(r){
    r[0]=1;  r[4]=0;  r[8]=0;  r[12]=0;
    r[1]=0;  r[5]=1;  r[9]=0;  r[13]=0;
    r[2]=0;  r[6]=0;  r[10]=1; r[14]=0;
    r[3]=0;  r[7]=0;  r[11]=0; r[15]=1;
}

// Traslación
function traslacion(matriz, tx, ty, tz){
    let r = new Array(16);
    r[0]=1; r[4]=0; r[8]=0; r[12]=tx;
    r[1]=0; r[5]=1; r[9]=0; r[13]=ty;
    r[2]=0; r[6]=0; r[10]=1; r[14]=tz;
    r[3]=0; r[7]=0; r[11]=0; r[15]=1;
    multiplica(matriz, matriz, r);
}

// Proyección ortogonal
function ortho(r, izq, der, abj, arr, cerca, lejos){
    r[0] = 2/(der-izq); r[4]=0; r[8]=0; r[12]=-(der+izq)/(der-izq);
    r[1] = 0; r[5]=2/(arr-abj); r[9]=0; r[13]=-(arr+abj)/(arr-abj);
    r[2] = 0; r[6]=0; r[10]=-2/(lejos-cerca); r[14]=-(lejos+cerca)/(lejos-cerca);
    r[3] = 0; r[7]=0; r[11]=0; r[15]=1;
}

// Multiplicación 4x4
function multiplica(c, a, b){
    let r = new Array(16);
    for(let i=0;i<4;i++){
        for(let j=0;j<4;j++){
            let s=0;
            for(let k=0;k<4;k++) s += a[i + k*4] * b[k + j*4];
            r[i + j*4] = s;
        }
    }
    for(let i=0;i<16;i++) c[i] = r[i];
}

// Crear forma
function createShape(vertices, colors){
    const vao = gl.createVertexArray();
    gl.bindVertexArray(vao);

    const vbo = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, vbo);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
    gl.enableVertexAttribArray(0);
    gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

    const cbo = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, cbo);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);
    gl.enableVertexAttribArray(1);
    gl.vertexAttribPointer(1, 4, gl.FLOAT, false, 0, 0);

    gl.bindVertexArray(null);
    return {vao: vao, count: vertices.length/2};
}

// Crear círculo
function circle(radius, r, g, b, a, segments=100){
    const verts = [0,0];
    const cols = [r,g,b,a];
    for(let i=0;i<=segments;i++){
        const ang = i * Math.PI*2 / segments;
        verts.push(Math.cos(ang)*radius);
        verts.push(Math.sin(ang)*radius);
        cols.push(r,g,b,a);
    }
    return createShape(verts, cols);
}

// Colores
function fillColors(nVertices, rgba){
    const out=[];
    for(let i=0;i<nVertices;i++) out.push(rgba[0],rgba[1],rgba[2],rgba[3]);
    return out;
}

function main(){
    canvas = document.getElementById("webglcanvas");
    gl = canvas.getContext("webgl2");
    gl.viewport(0,0,canvas.width,canvas.height);

    // shaders
    const vs = gl.createShader(gl.VERTEX_SHADER);
    gl.shaderSource(vs, document.getElementById("vs").text.trim());
    gl.compileShader(vs);
    const fs = gl.createShader(gl.FRAGMENT_SHADER);
    gl.shaderSource(fs, document.getElementById("fs").text.trim());
    gl.compileShader(fs);

    const prog = gl.createProgram();
    gl.attachShader(prog, vs);
    gl.attachShader(prog, fs);
    gl.linkProgram(prog);
    gl.useProgram(prog);

    uMatrizProyeccion = gl.getUniformLocation(prog,"uMatrizProyeccion");
    uMatrizVista = gl.getUniformLocation(prog,"uMatrizVista");
    uMatrizModelo = gl.getUniformLocation(prog,"uMatrizModelo");

    const aspect = canvas.width / canvas.height;
    ortho(MatrizProyeccion,-aspect,aspect,-1,1,-1,1);
    gl.uniformMatrix4fv(uMatrizProyeccion,false,MatrizProyeccion);

    identidad(MatrizVista);
    gl.uniformMatrix4fv(uMatrizVista,false,MatrizVista);

    gl.clearColor(0.04,0.06,0.17,1);
    gl.clear(gl.COLOR_BUFFER_BIT);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

    // fondo
    const bgVertices = [
        -aspect,-1,
         aspect,-1,
        -aspect, 1,
         aspect, 1
    ];
    const bgColors = [
        0.2,0.2,0.2,1,
        0.2,0.2,0.2,1,
        0.5,0.5,0.5,1,
        0.5,0.5,0.5,1
    ];
    const bg = createShape(bgVertices,bgColors);

    // sol
    const sun = circle(0.5,1,1,1,1);
    const glow = circle(1.2,1,1,1,0);

    // montañas
    const layer1 = createShape([
        -2,-1,
        -1,-0.1,
         1,-0.2,
         1, 0,
         2,-0.6,
        -2,-1,
         2,-1
    ], fillColors(7,[0.4,0.4,0.4,1])); // montaña 1

    const layer2 = createShape([
        -2, -0.8,
        -1.5,-0.2,
        -0.5,0,
         0.5,-0.1,
         1.5,-0.3,
         2,-0.8,
        -2,-1,
         2,-1
    ], fillColors(9,[0.3,0.3,0.3,1])); // montaña 2

    const layer3 = createShape([
        -2,-1,
        -1.5,-0.6,
         0,-0.7,
         1.5,-0.5,
         2,-1
    ], fillColors(5,[0.2,0.2,0.2,1])); // montaña 3

    // dibujar
    identidad(MatrizModelo);
    gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
    gl.bindVertexArray(bg.vao);
    gl.drawArrays(gl.TRIANGLE_STRIP,0,bg.count);

    identidad(MatrizModelo);
    gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
    gl.bindVertexArray(glow.vao);
    gl.drawArrays(gl.TRIANGLE_FAN,0,glow.count);

    identidad(MatrizModelo);
    gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
    gl.bindVertexArray(sun.vao);
    gl.drawArrays(gl.TRIANGLE_FAN,0,sun.count);

    identidad(MatrizModelo); traslacion(MatrizModelo,0,-0.1,0);
    gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
    gl.bindVertexArray(layer1.vao);
    gl.drawArrays(gl.TRIANGLE_STRIP,0,layer1.count);

    identidad(MatrizModelo); traslacion(MatrizModelo,0,-0.1,0);
    gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
    gl.bindVertexArray(layer2.vao);
    gl.drawArrays(gl.TRIANGLE_STRIP,0,layer2.count);

    identidad(MatrizModelo); traslacion(MatrizModelo,0,-0.1,0);
    gl.uniformMatrix4fv(uMatrizModelo,false,MatrizModelo);
    gl.bindVertexArray(layer3.vao);
    gl.drawArrays(gl.TRIANGLE_FAN,0,layer3.count);

    gl.bindVertexArray(null);
}

window.onload = main;
</script>
</body>
</html>
